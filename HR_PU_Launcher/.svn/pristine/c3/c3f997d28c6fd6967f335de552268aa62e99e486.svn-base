package com.mobilusauto.app.productionprocess;

import java.io.File;
import java.util.ArrayList;
import java.util.List;

import com.mobilusauto.app.productionprocess.R;

import android.app.Activity;
import android.bluetooth.BluetoothA2dp;
import android.bluetooth.BluetoothAdapter;
import android.bluetooth.BluetoothDevice;
import android.bluetooth.BluetoothProfile;
import android.bluetooth.BluetoothUuid;
import android.bluetooth.BluetoothProfile.ServiceListener;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.HMSIndex;
import android.content.Intent;
import android.content.IntentFilter;
import android.media.*;
import android.media.AudioManager.OnAudioFocusChangeListener;
import android.media.MediaRecorder.*;
import android.os.Build;
import android.os.Bundle;
import android.os.Handler;
import android.os.IHMSCommunicationService;
import android.os.IMTX;
import android.os.IYPService;
import android.os.Message;
import android.os.RemoteException;
import android.os.ServiceManager;
import android.os.SystemProperties;
import android.util.Log;
import android.view.*;
import android.view.View.OnClickListener;
import android.widget.*;
import android.widget.RelativeLayout.LayoutParams;

public class ILLActivity extends Activity implements OnClickListener{
	private TextView mTitle;
	private Button mResultOK, mResultNG;
	private int mIndex;
	
	private IntentFilter mIntentfilter; 
	private BroadcastReceiver mReceiver;
	
	public static final String ACTION_USER_REAR_CAMERA_START  	 = "android.intent.action.USER_REAR_CAMERA_START";
	public static final String ACTION_USER_REAR_CAMERA_STOP   	 = "android.intent.action.USER_REAR_CAMERA_STOP";
    private static final String ACTION_USER_ILL_START            = "android.intent.action.USER_ILL_START";
    private static final String ACTION_USER_ILL_STOP             = "android.intent.action.USER_ILL_STOP";
    private static final String ACTION_USER_ILL_M_START            = "android.intent.action.USER_ILL_M_START";
    private static final String ACTION_USER_ILL_M_STOP             = "android.intent.action.USER_ILL_M_STOP";
    private static final String ACTION_USER_AVTAIL_START            = "android.intent.action.USER_AVTAIL_START";
    private static final String ACTION_USER_AVTAIL_STOP             = "android.intent.action.USER_AVTAIL_STOP";
    
    public final int UNKNOWN = -1, ON = 0, OFF = 1;
    int mILL = UNKNOWN, mILL_M = UNKNOWN, mAVTAIL = UNKNOWN, mSpeed = UNKNOWN, mReverse  = UNKNOWN;
    
    TextView mTV_body=null;
    
    private IMTX mIHMS = IMTX.Stub.asInterface(ServiceManager.getService("motrex"));
    
    Handler mHandler = new Handler();
    Runnable mRunnable = new Runnable() {
		@Override
		public void run() {
			// TODO Auto-generated method stub
			try {
				mSpeed = (int)mIHMS.readGPIO((byte) 0x8D);
			} catch (RemoteException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			
			mUpdateScreen();
			mHandler.postDelayed(mRunnable, 1000);
		}
	};
    
	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_common);
		
		mIndex = getIntent().getIntExtra("_key", 0);
		String[] _str = getResources().getStringArray(R.array.arListTitle);
		
		View _view = (View) findViewById(R.id.top);
		
		mTitle = (TextView) _view.findViewById(R.id.tv_title);
		mTitle.setText(_str[mIndex]);
		
		mResultOK = (Button) _view.findViewById(R.id.bt_result_ok);
		mResultOK.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View arg0) {
				// TODO Auto-generated method stub
				MainActivity.getInstace().mSetResult(mIndex, MD_DEFINE.RESULT_OK);
				//onBackPressed();
				finish();
			}
		});
		mResultOK.setEnabled(false);
		
		mResultNG = (Button) _view.findViewById(R.id.bt_result_ng);
		mResultNG.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View arg0) {
				// TODO Auto-generated method stub
				MainActivity.getInstace().mSetResult(mIndex, MD_DEFINE.RESULT_NG);
//				onBackPressed();
				finish();
			}
		});
		mTV_body = (TextView)_view.findViewById(R.id.tv_body);
		mTV_body.setTextSize(21);
		mUpdateScreen();
		
//		try {
//			HMS_SERVICE.mDataTransmit(HMSIndex.CMD_H_LCD_POWER_ONOFF, HMSIndex.CMD_L_LCD_POWER_ONOFF, new byte[] {0x00});
//		} catch (RemoteException e) {
//			// TODO Auto-generated catch block
//			e.printStackTrace();
//		}
		
		mIntentfilter = new IntentFilter(); 
		mIntentfilter.addAction(ACTION_USER_REAR_CAMERA_START);
		mIntentfilter.addAction(ACTION_USER_REAR_CAMERA_STOP);
		mIntentfilter.addAction(ACTION_USER_ILL_START);
		mIntentfilter.addAction(ACTION_USER_ILL_STOP);
		mIntentfilter.addAction(ACTION_USER_ILL_M_START);
		mIntentfilter.addAction(ACTION_USER_ILL_M_STOP);
		mIntentfilter.addAction(ACTION_USER_AVTAIL_START);
		mIntentfilter.addAction(ACTION_USER_AVTAIL_STOP);
		
		mReceiver = new BroadcastReceiver() {
			@Override
			public void onReceive(Context arg0, Intent arg1) {
				// TODO Auto-generated method stub
				if(arg1.getAction().equals(ACTION_USER_REAR_CAMERA_START)) {
					mReverse = ON;
					mUpdateScreen();
				} else if(arg1.getAction().equals(ACTION_USER_REAR_CAMERA_STOP)) {
					mReverse = OFF;
					mUpdateScreen();
				} else if(arg1.getAction().equals(ACTION_USER_ILL_START)) {
					mILL = ON;
					mUpdateScreen();
				} else if(arg1.getAction().equals(ACTION_USER_ILL_STOP)) {
					mILL = OFF;
					mUpdateScreen();
				} else if(arg1.getAction().equals(ACTION_USER_ILL_M_START)) {
					mILL_M = ON;
					mUpdateScreen();
				} else if(arg1.getAction().equals(ACTION_USER_ILL_M_STOP)) {
					mILL_M = OFF;
					mUpdateScreen();
				} else if(arg1.getAction().equals(ACTION_USER_AVTAIL_START)) {
					mAVTAIL = ON;
					mUpdateScreen();
				} else if(arg1.getAction().equals(ACTION_USER_AVTAIL_STOP)) {
					mAVTAIL = OFF;
					mUpdateScreen();
				}
			}
		};
	}
	
	Handler mHandlerOKEnable = new Handler();
	Runnable mRunnableOKEnable = new Runnable() {
		@Override
		public void run() {
			// TODO Auto-generated method stub
			mResultOK.setEnabled(true);
		}
	};
	@Override
	protected void onResume() {
		
		mHandlerOKEnable.postDelayed(mRunnableOKEnable, _DEFINE.OK_ENABLE_TIME);
		registerReceiver(mReceiver, mIntentfilter);
		
		mHandler.postDelayed(mRunnable, 1000);
		
		super.onResume();
	};
	
	@Override
	protected void onPause() {
		// TODO Auto-generated method stub
		mHandlerOKEnable.removeCallbacks(mRunnableOKEnable);
		unregisterReceiver(mReceiver);
		mHandler.removeCallbacks(mRunnable);
		super.onPause();
	}

	@Override
	public void onClick(View arg0) {
		// TODO Auto-generated method stub
		
	}
	
	@Override
	public void onBackPressed() {
		// TODO Auto-generated method stub
	//	super.onBackPressed();
	}
	
	private void mUpdateScreen() {
		String _str = getString(R.string.str_ill_body);
		
		if(mILL == UNKNOWN)	_str = _str.replace("!s", "");
		else				_str = _str.replace("!s", mILL == ON ? "HIGH" : "LOW");
		
		if(mILL_M == UNKNOWN)	_str = _str.replace("@s", "");
		else					_str = _str.replace("@s", mILL_M == ON ? "HIGH" : "LOW");
		
		if(mAVTAIL == UNKNOWN)	_str = _str.replace("#s", "");
		else					_str = _str.replace("#s", mAVTAIL == ON ? "HIGH" : "LOW");
		
		if(mSpeed == UNKNOWN)	_str = _str.replace("$s", "");
		else					_str = _str.replace("$s", mSpeed == ON ? "ON" : "OFF");
		
		if(mReverse == UNKNOWN)	_str = _str.replace("%s", "");
		else					_str = _str.replace("%s", mReverse == ON ? "ON" : "OFF");
	
		mTV_body.setText(_str);
	}
}
